<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Platform - DEMO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
        }

        .demo-watermark {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            z-index: 102;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(251,191,36,0.3);
        }

        .search-bar {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 101;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 95%;
        }

        .search-input {
            padding: 12px 20px;
            border: none;
            border-radius: 24px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(12px);
            color: white;
            font-size: 14px;
            width: 220px;
            outline: none;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .search-input:focus {
            background: rgba(255,255,255,0.25);
            border-color: #fbbf24;
        }

        .search-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 24px;
            background: linear-gradient(135deg, #fe2c55 0%, #e91e63 100%);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(254,44,85,0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(254,44,85,0.4);
        }

        .clear-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 24px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 13px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            height: 100vh;
            width: 100vw;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        .container::-webkit-scrollbar {
            display: none;
        }

        .video-section {
            height: 100vh;
            width: 100%;
            position: relative;
            scroll-snap-align: start;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .controls {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 90px;
            color: white;
            z-index: 10;
        }

        .video-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .video-description {
            font-size: 15px;
            opacity: 0.95;
            margin-bottom: 10px;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8);
            line-height: 1.4;
        }

        .video-hashtags {
            font-size: 15px;
            font-weight: 700;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8);
        }

        .hashtag {
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 6px;
        }

        .hashtag:hover {
            color: #93c5fd;
            text-shadow: 0 0 8px rgba(96,165,250,0.5);
        }

        .sidebar {
            position: absolute;
            right: 16px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 28px;
            z-index: 10;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .action-btn:active {
            transform: scale(0.85);
        }

        .action-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .action-btn:hover .action-icon {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }

        .action-text {
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
        }

        .empty-state {
            color: white;
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state h2 {
            font-size: 26px;
            margin-bottom: 16px;
        }

        .empty-state p {
            opacity: 0.8;
            font-size: 16px;
            line-height: 1.6;
        }

        .liked {
            animation: likeAnimation 0.4s ease;
        }

        @keyframes likeAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .search-info {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(96,165,250,0.95);
            color: white;
            padding: 10px 24px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 700;
            z-index: 100;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 12px rgba(96,165,250,0.3);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }
            
            .demo-watermark {
                font-size: 10px;
                padding: 6px 14px;
                top: 10px;
            }
            
            .search-bar {
                top: 45px;
                gap: 8px;
            }
            
            .search-input {
                width: 160px;
                font-size: 12px;
                padding: 10px 16px;
            }
            
            .search-btn, .clear-btn {
                font-size: 11px;
                padding: 10px 16px;
            }

            .search-info {
                top: 100px;
                font-size: 11px;
                padding: 8px 16px;
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="demo-watermark">üì± VIEWER MODE - DEMO</div>
    
    <div class="search-bar">
        <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search hashtags..."
            onkeypress="handleSearchKeyPress(event)"
        >
        <button class="search-btn" onclick="searchHashtag()">üîç Search</button>
        <button class="clear-btn" onclick="clearSearch()">‚úï Clear</button>
    </div>

    <div id="searchInfo" class="search-info hidden"></div>

    <div class="container" id="videoContainer">
        <div class="video-section">
            <div class="empty-state">
                <h2>üé¨ No Videos Yet</h2>
                <p>Videos will appear here once uploaded by the admin. Try the admin version to add content!</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // LAZY LOADING CONFIGURATION
        // ============================================
        const PAGE_SIZE = 3;  // Load 3 videos at a time
        const PRELOAD_THRESHOLD = 1;  // Start loading next batch when 1 video away from end
        
        let allVideos = [];      // All video metadata (from localStorage)
        let displayedVideos = []; // Filtered videos to show
        let loadedVideos = [];    // Videos with blobs loaded (ready to play)
        let renderedCount = 0;    // How many videos are in the DOM
        let isLoading = false;    // Prevent duplicate loading
        let currentSearchTerm = '';
        let viewTracking = {};
        let watchTimeTracking = {};
        let userLikes = {};
        let loadMoreObserver = null;
        let videoPlayObserver = null;

        // ============================================
        // INDEXEDDB SETUP
        // ============================================
        const DB_NAME = 'VideoPlatformDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'videos';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function getVideoBlob(id) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result?.blob || null);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('Error accessing IndexedDB:', err);
                return null;
            }
        }

        // ============================================
        // LAZY LOADING CORE FUNCTIONS
        // ============================================
        
        // Load a single video's blob and create URL
        async function loadVideoBlob(video) {
            if (video.blobLoaded) return video; // Already loaded
            
            try {
                const blob = await getVideoBlob(video.id);
                if (blob) {
                    video.url = URL.createObjectURL(blob);
                    video.blobLoaded = true;
                }
            } catch (err) {
                console.error(`Error loading blob for ${video.id}:`, err);
            }
            return video;
        }

        // Load next batch of videos
        async function loadNextBatch() {
            if (isLoading) return;
            
            const startIndex = loadedVideos.length;
            const endIndex = Math.min(startIndex + PAGE_SIZE, displayedVideos.length);
            
            // Nothing more to load
            if (startIndex >= displayedVideos.length) return;
            
            isLoading = true;
            showLoadingIndicator();
            
            console.log(`Loading videos ${startIndex} to ${endIndex - 1}`);
            
            // Load blobs for next batch
            const batch = displayedVideos.slice(startIndex, endIndex);
            const loadPromises = batch.map(video => loadVideoBlob(video));
            await Promise.all(loadPromises);
            
            // Add to loaded videos
            loadedVideos.push(...batch);
            
            // Render the new videos
            appendVideosToDOM(batch, startIndex);
            
            hideLoadingIndicator();
            isLoading = false;
            
            // Pre-load next batch in background (for instant availability)
            preloadNextBatch();
        }

        // Pre-load blobs for upcoming videos (doesn't render them yet)
        async function preloadNextBatch() {
            const preloadStart = loadedVideos.length;
            const preloadEnd = Math.min(preloadStart + PAGE_SIZE, displayedVideos.length);
            
            if (preloadStart >= displayedVideos.length) return;
            
            console.log(`Pre-loading videos ${preloadStart} to ${preloadEnd - 1}`);
            
            const batch = displayedVideos.slice(preloadStart, preloadEnd);
            // Load in background without blocking
            batch.forEach(video => loadVideoBlob(video));
        }

        // Append videos to DOM (instead of re-rendering everything)
        function appendVideosToDOM(videos, startIndex) {
            const container = document.getElementById('videoContainer');
            
            // Remove empty state if present
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.parentElement.remove();
            }
            
            // Remove old load trigger if exists
            const oldTrigger = container.querySelector('.load-trigger');
            if (oldTrigger) oldTrigger.remove();
            
            videos.forEach((video, i) => {
                const index = startIndex + i;
                const section = createVideoSection(video, index);
                container.appendChild(section);
                
                // Observe for play/pause
                if (videoPlayObserver) {
                    videoPlayObserver.observe(section);
                }
            });
            
            // Add load trigger at the end
            if (loadedVideos.length < displayedVideos.length) {
                const trigger = document.createElement('div');
                trigger.className = 'load-trigger';
                trigger.style.height = '1px';
                container.appendChild(trigger);
                
                if (loadMoreObserver) {
                    loadMoreObserver.observe(trigger);
                }
            }
            
            renderedCount = loadedVideos.length;
        }

        // Create a single video section element
        function createVideoSection(video, index) {
            const section = document.createElement('div');
            section.className = 'video-section';
            section.setAttribute('data-video-id', video.id);
            section.setAttribute('data-index', index);
            
            const hashtags = video.hashtags 
                ? video.hashtags.split(' ')
                    .filter(tag => tag.startsWith('#'))
                    .map(tag => `<span class="hashtag" onclick="clickHashtag('${tag}')">${tag}</span>`)
                    .join('')
                : '';

            section.innerHTML = `
                <video 
                    id="video-${index}" 
                    src="${video.url || ''}" 
                    loop 
                    playsinline
                    muted
                    preload="metadata"
                ></video>
                
                <div class="controls">
                    <div class="video-title">${video.title}</div>
                    <div class="video-description">${video.description || ''}</div>
                    ${hashtags ? `<div class="video-hashtags">${hashtags}</div>` : ''}
                </div>

                <div class="sidebar">
                    <div class="action-btn" onclick="toggleLike(${index}, '${video.id}')">
                        <div class="action-icon" id="like-icon-${index}">${userLikes[video.id] ? '‚ù§Ô∏è' : 'ü§ç'}</div>
                        <div class="action-text" id="like-count-${index}">${video.likes || 0}</div>
                    </div>
                    <div class="action-btn" onclick="shareVideo(${index}, '${video.id}')">
                        <div class="action-icon">üì§</div>
                        <div class="action-text">Share</div>
                    </div>
                </div>
            `;
            
            return section;
        }

        function showLoadingIndicator() {
            let indicator = document.getElementById('loadingIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loadingIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 24px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 100;
                    backdrop-filter: blur(10px);
                `;
                indicator.textContent = '‚è≥ Loading videos...';
                document.body.appendChild(indicator);
            }
            indicator.style.display = 'block';
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // ============================================
        // INTERSECTION OBSERVERS
        // ============================================
        
        function setupObservers() {
            // Observer for loading more videos when scrolling near the end
            loadMoreObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isLoading) {
                        console.log('Load trigger visible, loading more...');
                        loadNextBatch();
                    }
                });
            }, { 
                root: document.getElementById('videoContainer'),
                rootMargin: '200% 0px' // Load when 2 screens away
            });

            // Observer for playing/pausing videos and preloading
            videoPlayObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    const videoId = entry.target.getAttribute('data-video-id');
                    const index = parseInt(entry.target.getAttribute('data-index'));
                    
                    if (video && videoId) {
                        if (entry.isIntersecting) {
                            video.play().catch(() => {});
                            trackView(videoId);
                            startWatchTimeTracking(videoId);
                            
                            // Check if we need to load more (PRELOAD_THRESHOLD from end)
                            if (index >= loadedVideos.length - PRELOAD_THRESHOLD - 1) {
                                loadNextBatch();
                            }
                        } else {
                            video.pause();
                            stopWatchTimeTracking(videoId);
                        }
                    }
                });
            }, { 
                root: document.getElementById('videoContainer'),
                threshold: 0.5 
            });
        }

        // ============================================
        // MAIN LOAD FUNCTION
        // ============================================
        
        async function loadVideos() {
            // Reset state
            loadedVideos = [];
            renderedCount = 0;
            
            // Load metadata only (fast!)
            const savedVideos = localStorage.getItem('demoVideos');
            const savedLikes = localStorage.getItem('demoLikes');
            
            allVideos = savedVideos ? JSON.parse(savedVideos) : [];
            userLikes = savedLikes ? JSON.parse(savedLikes) : {};
            
            // Mark all as not loaded
            allVideos.forEach(v => v.blobLoaded = false);
            
            if (currentSearchTerm) {
                filterByHashtag(currentSearchTerm);
            } else {
                displayedVideos = [...allVideos];
                await initializeVideos();
            }
        }

        async function initializeVideos() {
            const container = document.getElementById('videoContainer');
            
            if (displayedVideos.length === 0) {
                const message = currentSearchTerm 
                    ? `<h2>üîç No Results</h2><p>No videos match "${currentSearchTerm}"</p><p style="margin-top: 12px; opacity: 0.7;">Try a different hashtag or clear the search</p>`
                    : `<h2>üé¨ No Videos Yet</h2><p>Videos will appear here once uploaded by the admin. Try the admin version to add content!</p>`;
                
                container.innerHTML = `
                    <div class="video-section">
                        <div class="empty-state">
                            ${message}
                        </div>
                    </div>
                `;
                return;
            }
            
            // Clear container
            container.innerHTML = '';
            
            // Setup observers
            setupObservers();
            
            // Load first batch
            await loadNextBatch();
        }

        // ============================================
        // SEARCH & FILTER FUNCTIONS
        // ============================================

        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchHashtag();
            }
        }

        function searchHashtag() {
            let searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                clearSearch();
                return;
            }

            if (!searchTerm.startsWith('#')) {
                searchTerm = '#' + searchTerm;
            }

            currentSearchTerm = searchTerm.toLowerCase();
            filterByHashtag(currentSearchTerm);
        }

        async function filterByHashtag(hashtag) {
            // Reset loaded state
            loadedVideos = [];
            renderedCount = 0;
            
            displayedVideos = allVideos.filter(video => {
                if (!video.hashtags) return false;
                const videoHashtags = video.hashtags.toLowerCase().split(' ');
                return videoHashtags.some(tag => tag === hashtag);
            });
            
            // Mark filtered videos as not loaded
            displayedVideos.forEach(v => v.blobLoaded = false);

            const searchInfo = document.getElementById('searchInfo');
            if (displayedVideos.length > 0) {
                searchInfo.textContent = `Found ${displayedVideos.length} video${displayedVideos.length !== 1 ? 's' : ''} with ${hashtag}`;
                searchInfo.classList.remove('hidden');
            } else {
                searchInfo.textContent = `No videos found with ${hashtag}`;
                searchInfo.classList.remove('hidden');
            }

            await initializeVideos();
        }

        async function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchTerm = '';
            loadedVideos = [];
            renderedCount = 0;
            displayedVideos = [...allVideos];
            displayedVideos.forEach(v => v.blobLoaded = false);
            document.getElementById('searchInfo').classList.add('hidden');
            await initializeVideos();
        }

        function clickHashtag(hashtag) {
            document.getElementById('searchInput').value = hashtag;
            currentSearchTerm = hashtag.toLowerCase();
            filterByHashtag(currentSearchTerm);
            document.getElementById('videoContainer').scrollTo(0, 0);
        }

        // ============================================
        // ANALYTICS TRACKING
        // ============================================

        function trackView(videoId) {
            if (viewTracking[videoId]) return;
            viewTracking[videoId] = true;

            let analytics = JSON.parse(localStorage.getItem('demoAnalytics') || '{}');
            if (!analytics[videoId]) {
                analytics[videoId] = { views: 0, watchTime: 0, shares: 0 };
            }
            analytics[videoId].views++;
            localStorage.setItem('demoAnalytics', JSON.stringify(analytics));
        }

        function startWatchTimeTracking(videoId) {
            if (watchTimeTracking[videoId]) {
                watchTimeTracking[videoId].start = Date.now();
                return;
            }

            watchTimeTracking[videoId] = {
                start: Date.now(),
                totalTime: 0
            };
        }

        function stopWatchTimeTracking(videoId) {
            if (!watchTimeTracking[videoId]) return;

            const elapsed = (Date.now() - watchTimeTracking[videoId].start) / 1000;
            watchTimeTracking[videoId].totalTime += elapsed;

            let analytics = JSON.parse(localStorage.getItem('demoAnalytics') || '{}');
            if (!analytics[videoId]) {
                analytics[videoId] = { views: 0, watchTime: 0, shares: 0 };
            }
            analytics[videoId].watchTime += elapsed;
            localStorage.setItem('demoAnalytics', JSON.stringify(analytics));
        }

        function trackShare(videoId) {
            let analytics = JSON.parse(localStorage.getItem('demoAnalytics') || '{}');
            if (!analytics[videoId]) {
                analytics[videoId] = { views: 0, watchTime: 0, shares: 0 };
            }
            analytics[videoId].shares++;
            localStorage.setItem('demoAnalytics', JSON.stringify(analytics));
        }

        // Legacy function for compatibility (not used in lazy loading)
        function setupVideoObserver() {
            const container = document.getElementById('videoContainer');
            const videoSections = container.querySelectorAll('.video-section');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    const videoId = entry.target.getAttribute('data-video-id');
                    
                    if (video && videoId) {
                        if (entry.isIntersecting) {
                            video.play();
                            trackView(videoId);
                            startWatchTimeTracking(videoId);
                        } else {
                            video.pause();
                            stopWatchTimeTracking(videoId);
                        }
                    }
                });
            }, { threshold: 0.5 });

            videoSections.forEach(section => observer.observe(section));
        }

        function toggleLike(index, videoId) {
            const likeIcon = document.getElementById(`like-icon-${index}`);
            const likeCount = document.getElementById(`like-count-${index}`);
            const video = loadedVideos[index];
            
            if (!video) return;
            
            userLikes[videoId] = !userLikes[videoId];
            localStorage.setItem('demoLikes', JSON.stringify(userLikes));
            
            video.likes = userLikes[videoId] ? ((video.likes || 0) + 1) : Math.max(0, (video.likes || 0) - 1);
            
            const videoInAll = allVideos.find(v => v.id == videoId);
            if (videoInAll) {
                videoInAll.likes = video.likes;
                localStorage.setItem('demoVideos', JSON.stringify(allVideos));
            }
            
            likeIcon.textContent = userLikes[videoId] ? '‚ù§Ô∏è' : 'ü§ç';
            likeIcon.classList.add('liked');
            setTimeout(() => likeIcon.classList.remove('liked'), 400);
            
            likeCount.textContent = video.likes;
        }

        function shareVideo(index, videoId) {
            const video = loadedVideos[index];
            if (!video) return;
            
            const shareText = video.hashtags 
                ? `${video.title}\n\n${video.hashtags}`
                : video.title;

            trackShare(videoId);

            if (navigator.share) {
                navigator.share({
                    title: video.title,
                    text: shareText,
                    url: window.location.href
                }).catch(err => console.log('Error sharing:', err));
            } else {
                alert(`Link copied! Share: ${video.title}\n\nURL: ${window.location.href}`);
            }
        }

        // Smart auto-refresh: only reload if video count changed
        let lastVideoCount = 0;
        setInterval(() => {
            const savedVideos = localStorage.getItem('demoVideos');
            const currentVideos = savedVideos ? JSON.parse(savedVideos) : [];
            
            if (currentVideos.length !== lastVideoCount) {
                console.log('Video count changed, reloading...');
                lastVideoCount = currentVideos.length;
                loadVideos();
            }
        }, 3000);

        loadVideos();
    </script>
</body>
</html>
